<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Non-Billable Time Analysis</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segue UI', Roboto, sans-serif;
    }
    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    select, button {
      margin: 5px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 120px;
    }
    button {
      background: #f0f0f0;
      cursor: pointer;
    }
    button.active {
      background: #4CAF50;
      color: white;
    }
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .chart-wrapper {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 400px;
    }
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    #debug {
      padding: 10px;
      margin: 10px 0;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="debug"></div>
  <div class="filters">
    <select id="userFilter">
      <option value="all">All Users</option>
    </select>
    <select id="quarterFilter">
      <option value="all">All Time</option>
      <option value="Q1">Q1 (Jan-Mar)</option>
      <option value="Q2">Q2 (Apr-Jun)</option>
      <option value="Q3">Q3 (Jul-Sep)</option>
      <option value="Q4">Q4 (Oct-Dec)</option>
    </select>
  </div>

  <div class="summary-stats">
    <div class="stat-card">
      <div class="stat-value" id="totalHours">-</div>
      <div class="stat-label">Total Non-Billable Hours</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="avgHoursPerDay">-</div>
      <div class="stat-label">Avg Hours/Day</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="topProject">-</div>
      <div class="stat-label">Top Non-Billable Project</div>
    </div>
  </div>

  <div class="charts-container">
    <div class="chart-wrapper">
      <canvas id="distributionChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <script>
    let currentRecords = [];
    let charts = {};

    function log(message, data) {
      const debugDiv = document.getElementById('debug');
      const timestamp = new Date().toISOString();
      debugDiv.innerHTML = `${timestamp}: ${message}\n${JSON.stringify(data, null, 2)}`;
      console.log(message, data);
    }

    function getQuarter(date) {
      const month = new Date(date).getMonth();
      return `Q${Math.floor(month / 3) + 1}`;
    }

    function filterRecords(records, user, quarter) {
      let filtered = records;

      if (user !== 'all') {
        filtered = filtered.filter(r => r.User === user);
      }

      if (quarter !== 'all') {
        filtered = filtered.filter(r => getQuarter(r['Start Date']) === quarter);
      }

      return filtered;
    }

    function processData(records, user = 'all', quarter = 'all') {
      const filtered = filterRecords(records, user, quarter);
      
      log('Processing records', {
        totalRecords: records.length,
        filteredRecords: filtered.length,
        user,
        quarter
      });

      // Group by user and project
      const byUserProject = _.groupBy(filtered, 'User');
      
      // Calculate project distribution for each user
      const projectDistribution = {};
      Object.entries(byUserProject).forEach(([user, entries]) => {
        projectDistribution[user] = _.chain(entries)
          .groupBy('Project')
          .mapValues(group => _.sumBy(group, r => parseFloat(r['Duration (decimal)']) || 0))
          .value();
      });

      return {
        byUserProject,
        projectDistribution
      };
    }

    function createDistributionChart(data, user = 'all') {
      const ctx = document.getElementById('distributionChart').getContext('2d');
      
      if (charts.distribution) {
        charts.distribution.destroy();
      }

      let chartData;
      if (user === 'all') {
        // Aggregate all users
        chartData = _.chain(data.byUserProject)
          .flatMap()
          .groupBy('Project')
          .mapValues(group => _.sumBy(group, r => parseFloat(r['Duration (decimal)']) || 0))
          .entries()
          .value();
      } else {
        chartData = _.entries(data.projectDistribution[user] || {});
      }

      log('Distribution chart data', chartData);

      charts.distribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: chartData.map(([project]) => project),
          datasets: [{
            data: chartData.map(([, hours]) => hours),
            backgroundColor: [
              '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
              '#795548', '#607D8B', '#E91E63', '#9E9E9E', '#CDDC39'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Project Distribution - ${user === 'all' ? 'All Users' : user}`
            },
            legend: {
              position: 'right'
            }
          }
        }
      });
    }

    function createTrendChart(data, user = 'all') {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      if (charts.trend) {
        charts.trend.destroy();
      }

      let entries = user === 'all' ? 
        _.flatMap(data.byUserProject) :
        data.byUserProject[user] || [];

      const dailyHours = _.chain(entries)
        .groupBy(r => r['Start Date'])
        .mapValues(group => _.sumBy(group, r => parseFloat(r['Duration (decimal)']) || 0))
        .toPairs()
        .sortBy([0])
        .value();

      log('Trend chart data', dailyHours);

      charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dailyHours.map(([date]) => date),
          datasets: [{
            label: 'Hours',
            data: dailyHours.map(([, hours]) => hours),
            borderColor: '#4CAF50',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Daily Non-Billable Hours - ${user === 'all' ? 'All Users' : user}`
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours'
              }
            }
          }
        }
      });
    }

    function updateSummaryStats(data, user = 'all') {
      let entries = user === 'all' ? 
        _.flatMap(data.byUserProject) :
        data.byUserProject[user] || [];

      const totalHours = _.sumBy(entries, r => parseFloat(r['Duration (decimal)']) || 0);
      const uniqueDays = new Set(entries.map(r => r['Start Date'])).size;
      const avgHoursPerDay = uniqueDays ? (totalHours / uniqueDays) : 0;

      const topProject = _.chain(entries)
        .groupBy('Project')
        .mapValues(group => _.sumBy(group, r => parseFloat(r['Duration (decimal)']) || 0))
        .toPairs()
        .maxBy(1)
        .value();

      log('Summary stats', {
        totalHours,
        uniqueDays,
        avgHoursPerDay,
        topProject
      });

      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay.toFixed(1);
      document.getElementById('topProject').textContent = topProject ? topProject[0] : '-';
    }

    function updateFilters(records) {
      const users = [...new Set(records.map(r => r.User))].sort();
      const userFilter = document.getElementById('userFilter');
      
      userFilter.innerHTML = '<option value="all">All Users</option>';
      users.forEach(user => userFilter.add(new Option(user, user)));
    }

    function updateVisualizations() {
      const selectedUser = document.getElementById('userFilter').value;
      const selectedQuarter = document.getElementById('quarterFilter').value;
      
      const processedData = processData(currentRecords, selectedUser, selectedQuarter);
      createDistributionChart(processedData, selectedUser);
      createTrendChart(processedData, selectedUser);
      updateSummaryStats(processedData, selectedUser);
    }

    // Initialize Grist
    grist.ready();
    
    // Set up event listeners
    document.getElementById('userFilter').addEventListener('change', () => {
      updateVisualizations();
    });

    document.getElementById('quarterFilter').addEventListener('change', () => {
      updateVisualizations();
    });

    grist.onRecords(records => {
      log('Received records', {
        count: records.length,
        sampleRecord: records[0]
      });

      currentRecords = records;
      updateFilters(records);
      updateVisualizations();
    });
  </script>
</body>
</html>