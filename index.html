<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Non-Billable Time Analysis</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <!-- Same styles as before -->
  <style>
    /* Previous styles remain unchanged */
    #debug {
      padding: 10px;
      margin: 10px 0;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="debug"></div>
  <!-- Rest of the HTML structure remains the same -->

  <script>
    let currentRecords = [];
    let charts = {};

    function log(message, data) {
      const debugDiv = document.getElementById('debug');
      const timestamp = new Date().toISOString();
      const logMessage = `${timestamp}: ${message}\n${JSON.stringify(data, null, 2)}\n\n`;
      debugDiv.innerHTML = logMessage + debugDiv.innerHTML;
      console.log(message, data);
    }

    function validateAndParseRecord(record) {
      // Validate and clean the record data
      return {
        user: record.User || '',
        project: record.Project || '',
        startDate: record['Start Date'] || '',
        duration: parseFloat(record['Duration (decimal)']) || 0,
        description: record.Description || ''
      };
    }

    function processData(records) {
      log('Raw records received', {
        count: records.length,
        firstRecord: records[0],
        fields: records[0] ? Object.keys(records[0]) : []
      });

      // Clean and validate records
      const validRecords = records.map(validateAndParseRecord);
      
      log('Validated records', {
        count: validRecords.length,
        sample: validRecords[0]
      });

      // Group by user
      const byUser = _.groupBy(validRecords, 'user');
      
      log('Grouped by user', {
        userCount: Object.keys(byUser).length,
        users: Object.keys(byUser)
      });

      // Calculate project distribution
      const projectDistribution = {};
      Object.entries(byUser).forEach(([user, entries]) => {
        projectDistribution[user] = _.chain(entries)
          .groupBy('project')
          .mapValues(group => _.sumBy(group, 'duration'))
          .value();
      });

      log('Project distribution', {
        sample: Object.entries(projectDistribution)[0]
      });

      return {
        byUser,
        projectDistribution
      };
    }

    function createCharts(data, selectedUser = 'all') {
      // Create distribution chart (donut)
      const distributionCtx = document.getElementById('distributionChart').getContext('2d');
      if (charts.distribution) {
        charts.distribution.destroy();
      }

      let chartData;
      if (selectedUser === 'all') {
        // Aggregate all users
        chartData = _.chain(data.byUser)
          .flatMap()
          .groupBy('project')
          .mapValues(group => _.sumBy(group, 'duration'))
          .entries()
          .value();
      } else {
        chartData = _.entries(data.projectDistribution[selectedUser] || {});
      }

      log('Distribution chart data', chartData);

      charts.distribution = new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
          labels: chartData.map(([project]) => project),
          datasets: [{
            data: chartData.map(([, hours]) => hours),
            backgroundColor: [
              '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
              '#795548', '#607D8B', '#E91E63', '#9E9E9E', '#CDDC39'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Project Distribution - ${selectedUser === 'all' ? 'All Users' : selectedUser}`
            },
            legend: {
              position: 'right'
            }
          }
        }
      });

      // Create trend chart (line)
      const trendCtx = document.getElementById('trendChart').getContext('2d');
      if (charts.trend) {
        charts.trend.destroy();
      }

      const entries = selectedUser === 'all' ? 
        _.flatMap(data.byUser) :
        data.byUser[selectedUser] || [];

      const dailyHours = _.chain(entries)
        .groupBy('startDate')
        .mapValues(group => _.sumBy(group, 'duration'))
        .toPairs()
        .sortBy([0])
        .value();

      log('Trend chart data', {
        dataPoints: dailyHours.length,
        sample: dailyHours.slice(0, 3)
      });

      charts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: dailyHours.map(([date]) => date),
          datasets: [{
            label: 'Hours',
            data: dailyHours.map(([, hours]) => hours),
            borderColor: '#4CAF50',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Daily Non-Billable Hours - ${selectedUser === 'all' ? 'All Users' : selectedUser}`
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hours'
              }
            }
          }
        }
      });
    }

    function updateSummaryStats(data, selectedUser = 'all') {
      const entries = selectedUser === 'all' ? 
        _.flatMap(data.byUser) :
        data.byUser[selectedUser] || [];

      const totalHours = _.sumBy(entries, 'duration');
      const uniqueDays = new Set(entries.map(e => e.startDate)).size;
      const avgHoursPerDay = uniqueDays ? (totalHours / uniqueDays) : 0;

      const topProject = _.chain(entries)
        .groupBy('project')
        .mapValues(group => _.sumBy(group, 'duration'))
        .toPairs()
        .maxBy(1)
        .value();

      log('Summary calculation', {
        entries: entries.length,
        totalHours,
        uniqueDays,
        avgHoursPerDay,
        topProject
      });

      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('avgHoursPerDay').textContent = avgHoursPerDay.toFixed(1);
      document.getElementById('topProject').textContent = topProject ? topProject[0] : '-';
    }

    function updateFilters(records) {
      const users = [...new Set(records.map(r => r.User))].sort();
      const userFilter = document.getElementById('userFilter');
      
      userFilter.innerHTML = '<option value="all">All Users</option>';
      users.forEach(user => userFilter.add(new Option(user, user)));

      log('Updated filters', {
        userCount: users.length,
        users
      });
    }

    // Initialize Grist
    grist.ready({
      requiredHeight: 600
    });
    
    // Set up event listeners
    document.getElementById('userFilter').addEventListener('change', (e) => {
      const selectedUser = e.target.value;
      log('User selection changed', { selectedUser });
      
      const data = processData(currentRecords);
      createCharts(data, selectedUser);
      updateSummaryStats(data, selectedUser);
    });

    // Handle incoming data from Grist
    grist.onRecords(records => {
      log('Initial records received', {
        count: records.length,
        fields: records[0] ? Object.keys(records[0]) : [],
        sampleRecord: records[0]
      });

      currentRecords = records;
      updateFilters(records);
      
      const data = processData(records);
      createCharts(data);
      updateSummaryStats(data);
    });
  </script>
</body>
</html>